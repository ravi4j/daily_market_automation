name: Weekly S&P 500 Scan

on:
  # Run every Sunday at 6 PM EST (to catch weekly opportunities)
  schedule:
    - cron: '0 23 * * 0'  # 11:00 PM UTC Sunday = 6:00 PM EST Sunday
  
  # Allow manual trigger with options
  workflow_dispatch:
    inputs:
      sector:
        description: 'Filter by sector (optional)'
        required: false
        type: choice
        options:
          - 'All Sectors'
          - 'Information Technology'
          - 'Health Care'
          - 'Financials'
          - 'Consumer Discretionary'
          - 'Communication Services'
          - 'Industrials'
          - 'Consumer Staples'
          - 'Energy'
          - 'Utilities'
          - 'Real Estate'
          - 'Materials'
        default: 'All Sectors'
      top_n:
        description: 'Scan only top N stocks (for testing, leave empty for all)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  scan-sp500:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # S&P 500 scan takes longer
    
    env:
      TZ: America/New_York
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-base.txt
          pip install -r requirements-fetch.txt
          pip install tqdm lxml html5lib beautifulsoup4
      
      - name: Ensure directories exist
        run: mkdir -p signals data
      
      - name: Fetch S&P 500 list
        run: |
          echo "ðŸ“Š Fetching current S&P 500 constituents..."
          python scripts/fetch_sp500_list.py
      
      - name: Scan S&P 500 for opportunities
        run: |
          echo "ðŸ“° Scanning S&P 500 for buying opportunities..."
          
          SECTOR_ARG=""
          if [ "${{ github.event.inputs.sector }}" != "" ] && [ "${{ github.event.inputs.sector }}" != "All Sectors" ]; then
            SECTOR_ARG="--sector '${{ github.event.inputs.sector }}'"
          fi
          
          TOP_ARG=""
          if [ "${{ github.event.inputs.top_n }}" != "" ]; then
            TOP_ARG="--top ${{ github.event.inputs.top_n }}"
          fi
          
          python scripts/scan_sp500_news.py $SECTOR_ARG $TOP_ARG
      
      - name: Commit opportunities
        run: |
          git config user.name "automation-bot"
          git config user.email "bot@example.com"
          git add signals/sp500_opportunities.json data/metadata/sp500_symbols.json || true
          git commit -m "Update S&P 500 opportunities [skip ci]" || echo "No changes to commit"
          git push || echo "Push skipped"
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sp500-opportunities
          path: |
            signals/sp500_opportunities.json
            data/metadata/sp500_symbols.json
          retention-days: 30
      
      - name: Generate workflow summary
        if: always()
        run: |
          echo "## ðŸ“Š S&P 500 Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f signals/sp500_opportunities.json ]; then
            SCANNED=$(jq -r '.symbols_scanned' signals/sp500_opportunities.json)
            FOUND=$(jq -r '.opportunities_found' signals/sp500_opportunities.json)
            SCAN_TYPE=$(jq -r '.scan_type' signals/sp500_opportunities.json)
            
            echo "### ðŸ“Š Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Scan Type: **${SCAN_TYPE}**" >> $GITHUB_STEP_SUMMARY
            echo "- Stocks Scanned: **${SCANNED}**" >> $GITHUB_STEP_SUMMARY
            echo "- Opportunities Found: **${FOUND}**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "$FOUND" -gt 0 ]; then
              echo "### ðŸŽ¯ Top 10 Opportunities" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Rank | Symbol | Score | 5D Change | From 52W High | Company |" >> $GITHUB_STEP_SUMMARY
              echo "|------|--------|-------|-----------|---------------|---------|" >> $GITHUB_STEP_SUMMARY
              
              # Extract top 10 opportunities
              jq -r '.opportunities[:10] | to_entries | .[] | 
                "\(.key + 1) | \(.value.symbol) | \(.value.opportunity_score) | \(.value.fundamentals["5d_change"])% | \(.value.fundamentals.distance_from_52w_high)% | \(.value.fundamentals.company_name[:30])"' \
                signals/sp500_opportunities.json >> $GITHUB_STEP_SUMMARY || true
              
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ’¡ Check Telegram for detailed alerts" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… No significant buying opportunities detected" >> $GITHUB_STEP_SUMMARY
              echo "S&P 500 is generally stable or rising" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ No results file generated" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… Scan completed: $(date)" >> $GITHUB_STEP_SUMMARY

