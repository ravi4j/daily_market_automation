name: Daily Trading Alerts

on:
  # Run every day at 4:30 PM EST (after market close at 4:00 PM)
  schedule:
    - cron: '30 21 * * 1-5'  # 9:30 PM UTC = 4:30 PM EST (weekdays only)
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      min_confidence:
        description: 'Minimum confidence level'
        required: false
        default: 'MEDIUM'
        type: choice
        options:
          - LOW
          - MEDIUM
          - HIGH

permissions:
  contents: write

jobs:
  generate-alerts:
    runs-on: ubuntu-latest
    
    env:
      TZ: America/New_York
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install --index-url https://pypi.org/simple/ pandas-ta requests
          pip install -r requirements-base.txt
      
      - name: Ensure directories exist
        run: |
          mkdir -p data
          mkdir -p signals
      
      - name: Fetch latest price data
        run: |
          echo "ðŸ“Š Fetching latest market data..."
          python src/fetch_daily_prices.py
      
      - name: Run strategy analysis
        run: |
          echo "ðŸ” Running daily strategy analysis..."
          python src/strategy_runner.py
      
      - name: Send Telegram alerts
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            echo "ðŸ“¤ Sending alerts to Telegram..."
            MIN_CONF="${{ github.event.inputs.min_confidence }}"
            if [ -z "$MIN_CONF" ]; then
              MIN_CONF="MEDIUM"
            fi
            python scripts/send_daily_alerts.py --min-confidence "$MIN_CONF"
          else
            echo "âš ï¸  Telegram credentials not configured"
            echo "   Add TELEGRAM_BOT_TOKEN and TELEGRAM_CHAT_ID to GitHub Secrets"
            echo "   Alerts will be saved to signals/daily_alerts.json only"
          fi
      
      - name: Commit alerts
        run: |
          git config user.name "automation-bot"
          git config user.email "bot@example.com"
          git add signals/daily_alerts.json || true
          git commit -m "Generate daily trading alerts [skip ci]" || echo "No new alerts"
          git push || echo "Push skipped"
      
      - name: Upload alerts artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: daily-alerts
          path: signals/daily_alerts.json
          retention-days: 30
      
      - name: Generate workflow summary
        if: always()
        run: |
          echo "## ðŸš¨ Daily Trading Alerts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f signals/daily_alerts.json ]; then
            # Extract summary from JSON
            TOTAL=$(jq -r '.total_alerts' signals/daily_alerts.json)
            BUY=$(jq -r '.buy_signals' signals/daily_alerts.json)
            SELL=$(jq -r '.sell_signals' signals/daily_alerts.json)
            
            echo "### ðŸ“Š Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Alerts | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¢ BUY Signals | $BUY |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”´ SELL Signals | $SELL |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "$TOTAL" -gt 0 ]; then
              echo "### ðŸŽ¯ Alerts" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Symbol | Signal | Strategy | Confidence | Price |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|--------|----------|------------|-------|" >> $GITHUB_STEP_SUMMARY
              
              jq -r '.alerts[] | "\(.symbol)|\(.signal)|\(.strategy_name)|\(.confidence)|$\(.price)"' signals/daily_alerts.json | \
              while IFS='|' read -r symbol signal strategy conf price; do
                emoji="âšª"
                [ "$signal" = "BUY" ] && emoji="ðŸŸ¢"
                [ "$signal" = "SELL" ] && emoji="ðŸ”´"
                
                conf_emoji="â­"
                [ "$conf" = "HIGH" ] && conf_emoji="â­â­â­"
                [ "$conf" = "MEDIUM" ] && conf_emoji="â­â­"
                
                echo "| $emoji $symbol | $signal | $strategy | $conf $conf_emoji | $price |" >> $GITHUB_STEP_SUMMARY
              done
              
              echo "" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… No alerts today - all positions hold steady" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸  No alerts file generated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Alerts saved to:** signals/daily_alerts.json" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **View file:** [daily_alerts.json](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/signals/daily_alerts.json)" >> $GITHUB_STEP_SUMMARY

