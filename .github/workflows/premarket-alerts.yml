name: Pre-Market Gap Alerts

on:
  schedule:
    # Runs at 7 AM, 8 AM, 9 AM ET (12 PM, 1 PM, 2 PM UTC during DST)
    # Runs at 7 AM, 8 AM, 9 AM ET (11 AM, 12 PM, 1 PM UTC during standard time)
    # Note: GitHub Actions uses UTC, adjust for your timezone
    # Current schedule assumes standard time (Nov-Mar)
    - cron: '0 12 * * 1-5'  # 7 AM ET Mon-Fri (12 PM UTC)
    - cron: '0 13 * * 1-5'  # 8 AM ET Mon-Fri (1 PM UTC)
    - cron: '0 14 * * 1-5'  # 9 AM ET Mon-Fri (2 PM UTC)
  
  workflow_dispatch:  # Manual trigger for testing
    inputs:
      test_mode:
        description: 'Run in test mode'
        required: false
        default: 'false'

jobs:
  premarket-monitor:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          echo "ðŸ“¦ Installing Python dependencies..."
          pip install -r requirements-base.txt
      
      - name: Create necessary directories
        run: |
          mkdir -p logs
          mkdir -p data/cache
      
      - name: Check positions configured
        id: check_positions
        run: |
          echo "ðŸ“‹ Checking if positions are configured..."
          if grep -q "^  [A-Z]" config/premarket_config.yaml; then
            echo "has_positions=true" >> $GITHUB_OUTPUT
            echo "âœ… Positions found in config"
          else
            echo "has_positions=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No positions configured (positions section is empty/commented)"
          fi
      
      - name: Send pre-market alerts
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "ðŸŒ… Running pre-market gap monitor..."
          python scripts/send_premarket_alerts.py
      
      - name: Upload alert logs (if saved)
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: premarket-alerts
          path: logs/premarket_alerts_*.json
          if-no-files-found: ignore
          retention-days: 7
      
      - name: Workflow summary
        if: always()
        run: |
          echo "## ðŸŒ… Pre-Market Alert Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_positions.outputs.has_positions }}" = "true" ]; then
            echo "âœ… **Status:** Alerts sent for configured positions" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸  **Status:** No positions configured in premarket_config.yaml" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ **Action Required:** Add your positions to \`config/premarket_config.yaml\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â° **Run Time:** $(TZ='America/New_York' date '+%I:%M %p ET on %B %d, %Y')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Scheduled Runs:" >> $GITHUB_STEP_SUMMARY
          echo "- 7:00 AM ET (early warning)" >> $GITHUB_STEP_SUMMARY
          echo "- 8:00 AM ET (mid-check)" >> $GITHUB_STEP_SUMMARY
          echo "- 9:00 AM ET (final warning before open)" >> $GITHUB_STEP_SUMMARY

